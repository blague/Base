<!DOCTYPE html>
<html>
<head>
    <title>城市控件</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style>
        body, h1, h2, h3, h4, h5, h6, hr, p, blockquote, dl, dt, dd, ul, ol, li, pre,
        form, fieldset, legend, button, input, textarea, th, td {
            margin: 0;
            padding: 0;
        }

        body, button, input, select, textarea {
            font: 12px/1.5 tahoma, arial, \5b8b\4f53;
        }

        h1, h2, h3, h4, h5, h6 {
            font-size: 100%;
        }

        address, cite, dfn, em, var {
            font-style: normal;
        }

        code, kbd, pre, samp {
            font-family: courier new, courier, monospace;
        }

        small {
            font-size: 12px;
        }

        ul, ol {
            list-style: none;
        }

        a {
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        sup {
            vertical-align: text-top;
        }

        sub {
            vertical-align: text-bottom;
        }

        legend {
            color: #000;
        }

        fieldset, img {
            border: 0;
        }

        button, input, select, textarea {
            font-size: 100%;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0;
        }
    </style>
    <link type="text/css" href="css/city-select.css" rel="stylesheet"/>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/cityList.js"></script>
    <script type="text/javascript">
        /**
         *   城市选择控件
         */
        ;
        (function () {

            var opts,
                inputs ,//选择到的输入框
                target ,//当前选择的input
                targetRange,//当前input中的光标
                tipDivTmpl  ,//div外部模板
                tabTmpl ,//tab控件模板
                keyCode ,//keyCode集合
                flags,//标识集合
                term ,//输入值缓存
                searching ,//search方法，延迟执行。
                dataSource = {},//数据来源，这里是写死的加载js，之后替换getDataSource方法就可以更换为ajax
                cityArray,
                searchDiv,//提示层
                searchDivUl,//查询结果列表
                searchDivP,//页面显示
                selectItem,//当前选中项
                currentPage = 1,//当前页
                count = 0,//记录总页数
                searchCache=new Array();//所搜结果缓存，已经检索过的就不再检索了,这个集合中只是存在的在dataSource中的索引



            var defaults = {
                selector: "input[name*=cityname]",//选择器
                cssScope: "city-ui",//
                tabId :"#cityTab",
                searchId :"#search",
                delay :"200",//搜索的按键延迟时间,毫秒为单位
                cnSource:"js/cnAirPort.js",//国内数据来源
                intlSource:"js/iAirPort.js",//国际数据来源
                isIntl :false,//是否为国际
                pageSize:10,//每页显示结果数
                searchTitle:"可输入中文/全拼/简拼/三字码",
                tabTile:"",
                nullTip:"对不起，无匹配，请重新输入"
            };

            $.fn.citySelect = function (options) {
                return $.citySelect(options,this);
            }

            $.citySelect = function (options, obj) {
                $.citySelect.opts = opts = $.extend({}, defaults, options);
                _initValue();
                if (!obj) {
                    inputs = $(opts.selector);
                }
                inputs.focus(function (e){
                    if(target && target.is($(this)) && $("."+opts.cssScope+":visible").length) return ;
                    target = $(this);
                    _tip(opts.tabId);
                }).keyup(function (e){
                     _autoComplete(e);
                }).keydown(function (e){
                    switch (e.keyCode){
                        case keyCode.LEFT:
                        case keyCode.RIGHT:
                        case keyCode.UP:
                        case keyCode.DOWN:
                            e.preventDefault();
                    }
                })
                $("body").append(_tabs(cityList[0])).append(searchDiv);
                searchDiv = $(opts.searchId);
                searchDivUl = searchDiv.find("ul");
                searchDivP = searchDiv.find("p:last");
                _init();
            }

            // 创建城市点选控件
            function _tabs(data) {
                //创建选择框
                var $tabs = $(tipDivTmpl);
                $tabs.append(_tmpl(tabTmpl,{data:data}));
                $tabs.find("li").each(function (idx){
                    if(data[$(this).text()]){
                        $tabs.find("div").eq(idx).append(_tmpl(tabTmpl,{data:data[$(this).text()]}));
                    }
                })
                //绑定方法
                $tabs.find(".tab li").click(function(){
                    var $this = $(this);
                    $this.addClass("cur").siblings().removeClass('cur');
                    $this.parent().siblings("div").hide().eq($(this).index()).show();
                });
                $tabs.find(".cities li").mouseover(function (){
                    $(this).toggleClass("hover");
                }).mouseout(function (){
                    $(this).toggleClass("hover");
                }).click(function (){
                    $(opts.tabId).hide();
                    target.val($(this).text());
                });

                //初始化默认显示
                $tabs.find("div:first").addClass("on");
                $tabs.find("li:first").addClass("cur");
                $tabs.find("div:first div:first").addClass("on");
                $tabs.find("div:first li:first").addClass("cur");

                return $tabs;
            }

            function _tip(id) {
                _position(id);
            }

            function _position(id) {
                $(id).css({"top": target.position().top + target.height(), "left": target.position().left}).show();
            }

            //自动完成方法，onKeyup松开按键
            function _autoComplete(event) {
                switch( event.keyCode ) {
                    case keyCode.PAGE_UP:
                    case keyCode.LEFT:
                        _doPage( -1 );
                        break;
                    case keyCode.PAGE_DOWN:
                    case keyCode.RIGHT:
                        _doPage( 1 );
                        break;
                    case keyCode.UP:
                        _move( flags.PREV );
                        break;
                    case keyCode.DOWN:
                        _move( flags.NEXT );
                        break;
                    case keyCode.ENTER:
                    case keyCode.NUMPAD_ENTER:
                        if ( this.menu.active ) {
                            event.preventDefault();
                            this.menu.select( event );
                        }
                        break;
                    default:
                        _searchTimeout( event );
                        break;
                }
            }

            //搜索延迟
            function _searchTimeout ( event ) {
                clearTimeout( searching );
                searching = setTimeout(function() {
                    if(!_value() && $(opts.tabId).is(":hidden")){
                        _tip(opts.tabId);
                        searchDiv.hide();
                        return false;
                    }else{
                        $(opts.tabId).hide();
                        searchDiv.show();
                    }
                    if ( term !== _value() ) {
                        _search( event );
                        currentPage = 1;
                        _showSearhResult();
                    }
                }, opts.delay );
            }

            function _move(act){
                 if(!searchDivUl.children().length){
                    return ;
                 }else{
                    if(!act().length){
                       if(act == flags.NEXT){
                           selectItem = searchDivUl.children().first();
                       }else if(act == flags.PREV){
                           selectItem = searchDivUl.children().last();
                       }
                    }else{
                        selectItem = act();
                    }
                 }

                searchDivUl.find(".hover").removeClass("hover");
                $(selectItem).addClass("hover");
            }

            function _doPage(num){
                 if(0<currentPage+num && currentPage+num<=count){
                     currentPage+=num;
                     _showSearhResult();
                 }
            }

            function _showSearhResult(){
               searchDivUl.empty();
               searchDivP.empty();
               if(!searchCache[term].length){
                   searchDivUl.html(opts.nullTip);
                   return ;
               }
               count = Math.ceil(searchCache[term].length /opts.pageSize);
               for(var i =(currentPage- 1)*opts.pageSize,length=currentPage*opts.pageSize > searchCache[term].length ? searchCache[term].length : currentPage*opts.pageSize; i < length;i++){
                       searchDivUl.append("<li><h1>"+cityArray[searchCache[term][i]].name+"</h1><p>"+cityArray[searchCache[term][i]].airName+"</p></li>");
               }
               if(count != 1){
                   for(var j =1;j<=count;j++){
                       if(currentPage == j){
                           searchDivP.append(j);
                       }else{
                           searchDivP.append("<a>"+j+"</a>");
                       }
                   }
               }
               selectItem =searchDivUl.children().first().addClass("hover");
               searchDivUl.children().mouseover(function (){
                   selectItem.removeClass("hover");
                   selectItem = $(this);
                   selectItem.addClass("hover");
               })
            }
            //查询
            function _search( event){
                term = _value();

                //已经查询的取缓存
                if(!searchCache[term]){
                    var mather = new RegExp("^"+term,"gi");
                    cityArray = _getDataSource();
                    var nameArray=new Array(),enNameArray=new Array(),codeArray=new Array(),shotArray=new Array();
                    for(var i=0,length= cityArray.length;i<length;i++){
                         if(mather.test(cityArray[i].name)){
                              nameArray.push(i);
                         }else if(mather.test(cityArray[i].enName)){
                             enNameArray.push(i);
                         }else if(mather.test(cityArray[i].shot)){
                             shotArray.push(i);
                         } else if (mather.test(cityArray[i].code)){
                             codeArray.push(i);
                         }
                    }
                    searchCache[term] = nameArray.concat(enNameArray).concat(shotArray).concat(codeArray);
                }
            }

            function _getDataSource(){
                if(opts.isIntl){
                    if(!dataSource.intl){
                        dataSource.cn = dataSource.cn || _getJSON(opts.cnSource);
                        dataSource.intl = dataSource.cn.concat(_getJSON(opts.intlSource))
                    }
                    return dataSource.intl
                }else{
                    return dataSource.cn = dataSource.cn || _getJSON(opts.cnSource);
                }
            }

            //获得所有当前值
            function _value(){
                return $.trim(target.val());
            }
            function _getJSON(url){
                var temp ;
                $.ajax({
                        async:false,
                        url:url,
                        success:function (data){
                             temp = data;
                        },
                        dataType:"json"
                })
                return temp;
            }

            //模版方法
            function _tmpl(str, data) {
                var fn = new Function("obj",
                        "var p=[];" +
                                "with(obj){p.push('" +
                                str.replace(/\\/g, "\\\\")
                                        .replace(/[\r\t\n]/g, " ")
                                        .split("<#").join("\t")
                                        .replace(/((^|#>)[^t]*)'/g, "$1r")
                                        .replace(/\t=(.*?)#>/g, "',$1,'")
                                        .split("\t").join("');")
                                        .split("#>").join("p.push('")
                                        .split("\r").join("\\")
                                + "');}return p.join('');");
                return fn(data);
            }

            /**
             *初始化方法
             * @private
             */
            function _init() {
                /*fix : ie6 浮动被select遮盖*/
                if ($.browser.msie && /msie 6\.0/i.test(navigator.userAgent)) {
                        var html = '<iframe class="bgiframe"frameborder="0"tabindex="-1"src="javascript:false;"style="display:block;position:absolute;z-index:-1;filter:Alpha(Opacity=\'0\');top:expression(((parseInt(this.parentNode.currentStyle.borderTopWidth)||0)*-1)+\'px\');left:expression(((parseInt(this.parentNode.currentStyle.borderLeftWidth)||0)*-1)+\'px\');width:expression(this.parentNode.offsetWidth+\'px\');height:expression(this.parentNode.offsetHeight+\'px\');"/>';
                        $("."+opts.cssScope).each(function () {
                            if ($(this).children('iframe.bgiframe').length === 0)
                                this.insertBefore(document.createElement(html), this.firstChild);
                        })
                }

                $(document).mouseup(function  (e){
                    if($(e.target).closest("."+opts.cssScope+" , "+opts.selector).length == 0 ){
                        $("."+opts.cssScope).hide();
                    }
                });

            }

            /**
             * 初始化私有变量
             */
            function _initValue(){
                keyCode = {
                    BACKSPACE: 8,
                    COMMA: 188,
                    DELETE: 46,
                    DOWN: 40,
                    END: 35,
                    ENTER: 13,
                    ESCAPE: 27,
                    HOME: 36,
                    LEFT: 37,
                    PAGE_DOWN: 34,
                    PAGE_UP: 33,
                    PERIOD: 190,
                    RIGHT: 39,
                    SPACE: 32,
                    TAB: 9,
                    UP: 38
                }

               //集合中值无意义，只是做标识，KEY值才是其代表的意义。
               flags ={
                   PAGE :1,//翻页
                   ITEM : 2, //移动
                   NEXT : function (){ return selectItem.next();},//下一个
                   PREV : function (){ return selectItem.prev();}//上一个
               }

                tipDivTmpl = '<div id="'+opts.tabId.replace("#","")+'" class="'+opts.cssScope+'"></div>';//tip最外层div

                tabTmpl ='<ul class="tab">' +
                        '<# for (var i in data) { #>' +
                        '<li><#= i #></li> ' +
                        '<# } #>' +
                        '</ul>' +
                        '<# for (var i in data) { #>' +
                        '<div>' +
                        '<# if (Object.prototype.toString.apply(data[i]) === "[object Array]") { #>' +
                        '<ul class="cities">' +
                        '<# for (var j = 0,length = data[i].length;j<length;j++){ #>' +
                        '<li data="<#= data[i][j].id#>"><#= data[i][j].name#></li>' +
                        '<# } #>' +
                        '</ul>' +
                        '<# } #>' +
                        '</div>'+
                        '<# } #>';

                searchDiv = '<div class="city-ui" id="'+opts.searchId.replace("#","")+'"> <p> '+opts.searchTitle+' </p> <ul class="result"></ul> <p></p> </div>';
            }

        })(jQuery);

        $(function (){
            $.citySelect();
        })
    </script>
</head>
<body>
<div style="margin: 0 auto;width: 960px;">
    <br/>
    <input class="city" name="cfcityname"/><input class="city" name="aa" value="aaaaa"/>
    <br/>
    select控件遮盖测试:<select>
    <option>1select控件遮盖测试</option>
    <option>2select控件遮盖测试</option>
    <option>3select控件遮盖测试</option>
    <option>4select控件遮盖测试</option>
</select>
</div>

</body>
</html>