<!DOCTYPE html>
<html>
<head>
    <title>城市控件</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style>
        body, h1, h2, h3, h4, h5, h6, hr, p, blockquote, dl, dt, dd, ul, ol, li, pre,
        form, fieldset, legend, button, input, textarea, th, td {
            margin: 0;
            padding: 0;
        }

        body, button, input, select, textarea {
            font: 12px/1.5 tahoma, arial, \5b8b\4f53;
        }

        h1, h2, h3, h4, h5, h6 {
            font-size: 100%;
        }

        address, cite, dfn, em, var {
            font-style: normal;
        }

        code, kbd, pre, samp {
            font-family: courier new, courier, monospace;
        }

        small {
            font-size: 12px;
        }

        ul, ol {
            list-style: none;
        }

        a {
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        sup {
            vertical-align: text-top;
        }

        sub {
            vertical-align: text-bottom;
        }

        legend {
            color: #000;
        }

        fieldset, img {
            border: 0;
        }

        button, input, select, textarea {
            font-size: 100%;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0;
        }
    </style>
    <link type="text/css" href="css/city-select.css" rel="stylesheet"/>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/cityList.js"></script>
    <script type="text/javascript" src="js/iAirPort.js"></script>
    <script type="text/javascript" src="js/cnAirPort.js"></script>
    <script type="text/javascript">
        /**
         *   城市选择控件
         */
        ;
        (function () {

            var opts, inputs , target , tipDivTmpl , tabTmpl , keyCode,term,searching;

            var defaults = {
                selector: "input[name*=cityname]",
                selectDiv: "city-ui",
                delay :"200"
            };

            $.fn.citySelect = function (options) {
                return $.citySelect(options,this);
            }

            $.citySelect = function (options, obj) {
                opts = $.extend({}, defaults, options);
                _initValue();
                if (!obj) {
                    inputs = $(opts.selector);
                }
                inputs.focus(function (e){
                    target = this;
                    _tip();
                }).keyup(function (e){

                })
                $("body").append(_tabs(cityList[0]));
                _init();
            }

            // 创建城市点选控件
            function _tabs(data) {
                //创建选择框
                var $tabs = $(tipDivTmpl);
                $tabs.append(_tmpl(tabTmpl,{data:data}));
                $tabs.find("li").each(function (idx){
                    if(data[$(this).text()]){
                        $tabs.find("div").eq(idx).append(_tmpl(tabTmpl,{data:data[$(this).text()]}));
                    }
                })
                //绑定方法
                $tabs.find(".tab li").click(function(){
                    var $this = $(this);
                    $this.addClass("cur").siblings().removeClass('cur');
                    $this.parent().siblings("div").hide().eq($(this).index()).show();
                });
                $tabs.find(".cities li").mouseover(function (){
                    $(this).toggleClass("grey");
                }).mouseout(function (){
                    $(this).toggleClass("grey");
                }).click(function (){
                    $(".city-ui").hide();
                    target.value = $(this).text();
                });



                //初始化默认显示
                $tabs.find("div:first").addClass("on");
                $tabs.find("li:first").addClass("cur");
                $tabs.find("div:first div:first").addClass("on");
                $tabs.find("div:first li:first").addClass("cur");


                return $tabs;
            }

            //tip方法,onFocus且输入框中无值
            function _tip() {
                _position($(target));
            }

            function _position($dom) {
                $(".city-ui").css({"top": $dom.position().top + $dom.height(), "left": $dom.position().left}).show();
            }


            //自动完成方法，onKeyup松开按键
            function _autoComplete(event) {
                switch( event.keyCode ) {
                    case keyCode.PAGE_UP:
                    case keyCode.LEFT:
                        this._move( -2, event );
                        break;
                    case keyCode.PAGE_DOWN:
                    case keyCode.RIGHT:
                        this._move( 2, event );
                        break;
                    case keyCode.UP:
                        this._move( -1, event );
                        break;
                    case keyCode.DOWN:
                        this._move( -2, event );
                        break;
                    case keyCode.ENTER:
                    case keyCode.NUMPAD_ENTER:
                        //判断提示层是否显示
                        if ( this.menu.active ) {
                            event.preventDefault();
                            this.menu.select( event );
                        }
                        break;
                    case keyCode.TAB:
                        if ( this.menu.active ) {
                            this.menu.select( event );
                        }
                        break;
                    /*case keyCode.ESCAPE:
                        if ( this.menu.element.is( ":visible" ) ) {
                            this._value( this.term );
                            this.close( event );
                            event.preventDefault();
                        }
                        break;*/
                    default:
                        this._searchTimeout( event );
                        break;
                }
            }

            //搜索延迟
            function _searchTimeout ( event ) {
                clearTimeout( searching );
                searching = setTimeout(function() {
                    if ( term !== _value() ) {
                        _search( null, event );
                    }
                }, opts.delay );
            }

            //查询
            function _search( value, event){
                 term = _value();

            }

            //获得所有当前值
            function _value(){
                return $(target).val();
            }

            //模版方法
            function _tmpl(str, data) {
                var fn = new Function("obj",
                        "var p=[];" +
                                "with(obj){p.push('" +
                                str.replace(/\\/g, "\\\\")
                                        .replace(/[\r\t\n]/g, " ")
                                        .split("<#").join("\t")
                                        .replace(/((^|#>)[^t]*)'/g, "$1r")
                                        .replace(/\t=(.*?)#>/g, "',$1,'")
                                        .split("\t").join("');")
                                        .split("#>").join("p.push('")
                                        .split("\r").join("\\")
                                + "');}return p.join('');");
                return fn(data);
            }

            /**
             *初始化方法
             * @private
             */
            function _init() {
                /*fix : ie6 浮动被select遮盖*/
                if ($.browser.msie && /msie 6\.0/i.test(navigator.userAgent)) {
                        var html = '<iframe class="bgiframe"frameborder="0"tabindex="-1"src="javascript:false;"style="display:block;position:absolute;z-index:-1;filter:Alpha(Opacity=\'0\');top:expression(((parseInt(this.parentNode.currentStyle.borderTopWidth)||0)*-1)+\'px\');left:expression(((parseInt(this.parentNode.currentStyle.borderLeftWidth)||0)*-1)+\'px\');width:expression(this.parentNode.offsetWidth+\'px\');height:expression(this.parentNode.offsetHeight+\'px\');"/>';
                        $(".city-ui").each(function () {
                            if ($(this).children('iframe.bgiframe').length === 0)
                                this.insertBefore(document.createElement(html), this.firstChild);
                        })
                }

                $(document).mouseup(function  (e){
                    if($(e.target).closest(".city-ui ,"+opts.selector).length == 0 ){
                        $(".city-ui").hide();
                    }
                });

            }

            /**
             * 初始化私有变量
             */
            function _initValue(){
                keyCode = {
                    BACKSPACE: 8,
                    COMMA: 188,
                    DELETE: 46,
                    DOWN: 40,
                    END: 35,
                    ENTER: 13,
                    ESCAPE: 27,
                    HOME: 36,
                    LEFT: 37,
                    PAGE_DOWN: 34,
                    PAGE_UP: 33,
                    PERIOD: 190,
                    RIGHT: 39,
                    SPACE: 32,
                    TAB: 9,
                    UP: 38
                } //65-90为a-z有效输入这个时候才会去检索

                tipDivTmpl = '<div class="'+opts.selectDiv+'"></div>';//tip最外层div

                tabTmpl ='<ul class="tab">' +
                        '<# for (var i in data) { #>' +
                        '<li><#= i #></li> ' +
                        '<# } #>' +
                        '</ul>' +
                        '<# for (var i in data) { #>' +
                        '<div>' +
                        '<# if (Object.prototype.toString.apply(data[i]) === "[object Array]") { #>' +
                        '<ul class="cities">' +
                        '<# for (var j = 0,length = data[i].length;j<length;j++){ #>' +
                        '<li data="<#= data[i][j].id#>"><#= data[i][j].name#></li>' +
                        '<# } #>' +
                        '</ul>' +
                        '<# } #>' +
                        '</div>'+
                        '<# } #>';
            }

        })(jQuery);

        $(function (){
            $.citySelect();
        })
    </script>
</head>
<body>
<div style="margin: 0 auto;width: 960px;">
    <br/>
    <input class="city" name="cfcityname"/><input class="city" name="aa"/>
    <br/>
    select控件遮盖测试:<select>
    <option>1select控件遮盖测试</option>
    <option>2select控件遮盖测试</option>
    <option>3select控件遮盖测试</option>
    <option>4select控件遮盖测试</option>
</select>
</div>


</body>
</html>