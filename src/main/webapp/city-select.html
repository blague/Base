<!DOCTYPE html>
<html>
<head>
    <title>城市控件</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style>
        body, h1, h2, h3, h4, h5, h6, hr, p, blockquote, dl, dt, dd, ul, ol, li, pre,
        form, fieldset, legend, button, input, textarea, th, td {
            margin: 0;
            padding: 0;
        }

        body, button, input, select, textarea {
            font: 12px/1.5 tahoma, arial, \5b8b\4f53;
        }

        h1, h2, h3, h4, h5, h6 {
            font-size: 100%;
        }

        address, cite, dfn, em, var {
            font-style: normal;
        }

        code, kbd, pre, samp {
            font-family: courier new, courier, monospace;
        }

        small {
            font-size: 12px;
        }

        ul, ol {
            list-style: none;
        }

        a {
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        sup {
            vertical-align: text-top;
        }

        sub {
            vertical-align: text-bottom;
        }

        legend {
            color: #000;
        }

        fieldset, img {
            border: 0;
        }

        button, input, select, textarea {
            font-size: 100%;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0;
        }
    </style>
    <link type="text/css" href="css/city-select.css" rel="stylesheet"/>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/cityList.js"></script>
    <script type="text/javascript">
        /**
         *   城市选择控件
         */
        ;
        (function () {

            var opts,
                inputs ,//选择到的输入框
                target ,//当前选择的input
                tipDivTmpl  ,//div外部模板
                tabTmpl ,//tab控件模板
                keyCode ,//keyCode集合
                term ,//输入值缓存
                searching ,//
                dataSource = {},//数据来源，这里是写死的加载js，之后替换getDataSource方法就可以更换为ajax
                cityArray,
                searchDiv,//提示层
                searchDivUl,
                searchDivP,
                currentPage = 1,//当前页
                searchCache=new Array();//所搜结果缓存，已经检索过的就不再检索了,这个集合中只是存在的在dataSource中的索引

            var defaults = {
                selector: "input[name*=cityname]",//选择器
                cssScope: "city-ui",//
                tabId :"#cityTab",
                searchId :"#search",
                delay :"200",//搜索的按键延迟时间,毫秒为单位
                cnSource:"js/cnAirPort.js",//国内数据来源
                intlSource:"js/iAirPort.js",//国际数据来源
                isIntl :true,//是否为国际
                pageSize:10//每页显示结果数
            };

            $.fn.citySelect = function (options) {
                return $.citySelect(options,this);
            }

            $.citySelect = function (options, obj) {
                $.citySelect.opts = opts = $.extend({}, defaults, options);
                _initValue();
                if (!obj) {
                    inputs = $(opts.selector);
                }
                inputs.focus(function (e){
                    target = this;
                    _tip();
                }).keyup(function (e){
                     _autoComplete(e);
                })
                $("body").append(_tabs(cityList[0])).append(searchDiv);
                searchDiv = $(opts.searchId);
                searchDivUl = searchDiv.find("ul");
                searchDivP = searchDiv.find("p:last");
                _init();
            }

            // 创建城市点选控件
            function _tabs(data) {
                //创建选择框
                var $tabs = $(tipDivTmpl);
                $tabs.append(_tmpl(tabTmpl,{data:data}));
                $tabs.find("li").each(function (idx){
                    if(data[$(this).text()]){
                        $tabs.find("div").eq(idx).append(_tmpl(tabTmpl,{data:data[$(this).text()]}));
                    }
                })
                //绑定方法
                $tabs.find(".tab li").click(function(){
                    var $this = $(this);
                    $this.addClass("cur").siblings().removeClass('cur');
                    $this.parent().siblings("div").hide().eq($(this).index()).show();
                });
                $tabs.find(".cities li").mouseover(function (){
                    $(this).toggleClass("hover");
                }).mouseout(function (){
                    $(this).toggleClass("hover");
                }).click(function (){
                    $(opts.tabId).hide();
                    target.value = $(this).text();
                });

                //初始化默认显示
                $tabs.find("div:first").addClass("on");
                $tabs.find("li:first").addClass("cur");
                $tabs.find("div:first div:first").addClass("on");
                $tabs.find("div:first li:first").addClass("cur");

                return $tabs;
            }

            //tip方法,onFocus且输入框中无值
            function _tip() {
                _position($(target));
            }

            function _position($dom) {
                $(opts.tabId).css({"top": $dom.position().top + $dom.height(), "left": $dom.position().left}).show();
            }


            //自动完成方法，onKeyup松开按键
            function _autoComplete(event) {
                switch( event.keyCode ) {
                    case keyCode.PAGE_UP:
                    case keyCode.LEFT:
                        this._move( -2, event );
                        break;
                    case keyCode.PAGE_DOWN:
                    case keyCode.RIGHT:
                        this._move( 2, event );
                        break;
                    case keyCode.UP:
                        this._move( -1, event );
                        break;
                    case keyCode.DOWN:
                        this._move( 1, event );
                        break;
                    case keyCode.ENTER:
                    case keyCode.NUMPAD_ENTER:
                        if ( this.menu.active ) {
                            event.preventDefault();
                            this.menu.select( event );
                        }
                        break;
                    default:
                        _searchTimeout( event );
                        break;
                }
            }

            //搜索延迟
            function _searchTimeout ( event ) {
                if(!_value() && $(opts.tabId).is(":hidden")){
                    _tip();
                    return false;
                }else{
                    $(opts.tabId).hide();
                   searchDiv.show();
                }
                clearTimeout( searching );
                searching = setTimeout(function() {
                    if ( term !== _value() ) {
                        _search( event );
                        _showSearhResult();
                    }
                }, opts.delay );
            }

            function _move(flag,event){
                console.log("未实现")
            }
            function _showSearhResult(){
               searchDivUl.empty();
               searchDivP.empty();
               var count = Math.ceil(searchCache[term].length % opts.pageSize);
               for(var i =(currentPage- 1)*opts.pageSize,length=currentPage*opts.pageSize;i<length;i++){
                   searchDivUl.append("<li><h1>"+cityArray[searchCache[term][i]].name+"</h1><p>"+cityArray[searchCache[term][i]].airName+"</p></li>");
               }
               for(var i =0;i<count;i++){
                    if(currentPage == i+1){
                        searchDivP.append((i+1));
                    }else{
                        searchDivP.append("<a>"+(i+1)+"</a>");
                    }
               }
            }
            //查询
            function _search( event){
                term = _value();

                //已经查询的取缓存
                if(!searchCache[term]){
                    var mather = new RegExp("^"+term,"gi");
                    cityArray = _getDataSource();
                    var nameArray=new Array(),enNameArray=new Array(),codeArray=new Array(),shotArray=new Array();
                    for(var i=0,length= cityArray.length;i<length;i++){
                         if(mather.test(cityArray[i].name)){
                              nameArray.push(i);
                         }else if(mather.test(cityArray[i].enName)){
                             enNameArray.push(i);
                         }else if(mather.test(cityArray[i].shot)){
                             shotArray.push(i);
                         } else if (mather.test(cityArray[i].code)){
                             codeArray.push(i);
                         }
                    }
                    searchCache[term] = nameArray.concat(enNameArray).concat(shotArray).concat(codeArray);
                }
            }

            function _getDataSource(){
                if(opts.isIntl){
                    if(!dataSource.intl){
                        dataSource.cn = dataSource.cn || _getJSON(opts.cnSource);
                        dataSource.intl = dataSource.cn.concat(_getJSON(opts.intlSource))
                    }
                    return dataSource.intl
                }else{
                    return dataSource.cn = dataSource.cn || _getJSON(opts.cnSource);
                }
            }

            //获得所有当前值
            function _value(){
                return $.trim($(target).val());
            }
            function _getJSON(url){
                var temp ;
                $.ajax({
                        async:false,
                        url:url,
                        success:function (data){
                             temp = data;
                        },
                        dataType:"json"
                })
                return temp;
            }

            //模版方法
            function _tmpl(str, data) {
                var fn = new Function("obj",
                        "var p=[];" +
                                "with(obj){p.push('" +
                                str.replace(/\\/g, "\\\\")
                                        .replace(/[\r\t\n]/g, " ")
                                        .split("<#").join("\t")
                                        .replace(/((^|#>)[^t]*)'/g, "$1r")
                                        .replace(/\t=(.*?)#>/g, "',$1,'")
                                        .split("\t").join("');")
                                        .split("#>").join("p.push('")
                                        .split("\r").join("\\")
                                + "');}return p.join('');");
                return fn(data);
            }

            /**
             *初始化方法
             * @private
             */
            function _init() {
                /*fix : ie6 浮动被select遮盖*/
                if ($.browser.msie && /msie 6\.0/i.test(navigator.userAgent)) {
                        var html = '<iframe class="bgiframe"frameborder="0"tabindex="-1"src="javascript:false;"style="display:block;position:absolute;z-index:-1;filter:Alpha(Opacity=\'0\');top:expression(((parseInt(this.parentNode.currentStyle.borderTopWidth)||0)*-1)+\'px\');left:expression(((parseInt(this.parentNode.currentStyle.borderLeftWidth)||0)*-1)+\'px\');width:expression(this.parentNode.offsetWidth+\'px\');height:expression(this.parentNode.offsetHeight+\'px\');"/>';
                        $("."+opts.cssScope).each(function () {
                            if ($(this).children('iframe.bgiframe').length === 0)
                                this.insertBefore(document.createElement(html), this.firstChild);
                        })
                }

                $(document).mouseup(function  (e){
                    if($(e.target).closest(opts.tabId+" , "+opts.selector).length == 0 ){
                        $(opts.tabId).hide();
                    }
                });

            }

            /**
             * 初始化私有变量
             */
            function _initValue(){
                keyCode = {
                    BACKSPACE: 8,
                    COMMA: 188,
                    DELETE: 46,
                    DOWN: 40,
                    END: 35,
                    ENTER: 13,
                    ESCAPE: 27,
                    HOME: 36,
                    LEFT: 37,
                    PAGE_DOWN: 34,
                    PAGE_UP: 33,
                    PERIOD: 190,
                    RIGHT: 39,
                    SPACE: 32,
                    TAB: 9,
                    UP: 38
                } //65-90为a-z有效输入这个时候才会去检索

                tipDivTmpl = '<div id="'+opts.tabId.replace("#","")+'" class="'+opts.cssScope+'"></div>';//tip最外层div

                tabTmpl ='<ul class="tab">' +
                        '<# for (var i in data) { #>' +
                        '<li><#= i #></li> ' +
                        '<# } #>' +
                        '</ul>' +
                        '<# for (var i in data) { #>' +
                        '<div>' +
                        '<# if (Object.prototype.toString.apply(data[i]) === "[object Array]") { #>' +
                        '<ul class="cities">' +
                        '<# for (var j = 0,length = data[i].length;j<length;j++){ #>' +
                        '<li data="<#= data[i][j].id#>"><#= data[i][j].name#></li>' +
                        '<# } #>' +
                        '</ul>' +
                        '<# } #>' +
                        '</div>'+
                        '<# } #>';

                searchDiv = '<div class="city-ui" id="'+opts.searchId.replace("#","")+'"> <p> 可以输入拼音/简拼/三字码/汉字 </p> <ul class="result"></ul> <p></p> </div>';
            }

        })(jQuery);

        $(function (){
            $.citySelect();
        })
    </script>
</head>
<body>
<div style="margin: 0 auto;width: 960px;">
    <br/>
    <input class="city" name="cfcityname"/><input class="city" name="aa"/>
    <br/>
    select控件遮盖测试:<select>
    <option>1select控件遮盖测试</option>
    <option>2select控件遮盖测试</option>
    <option>3select控件遮盖测试</option>
    <option>4select控件遮盖测试</option>
</select>
</div>

</body>
</html>